#!/bin/sh
# Usage: jqcolors [FILE]
#
# This script allows colors to be set for jq(1) using a file with roughly the
# same format used by dircolors(1): each consists of a name and escape sequence
# used for that particular type of token. Comments are demarcated by "#"s. When
# a particular token does not have an explicit value, the default is used. If
# not file is passed an argument, all colors are set to their defaults. The
# output generated by this program is suitable for execution in
# Bourne-compatible shells and will export the "JQ_COLORS" environment variable
# configured accordingly. The following token types are recognized:
#
# - ARRAY: Rectangular brackets used for array literals.
# - FALSE: Literal "false" tokens.
# - FIELD: Strings used for object keys.
# - NULL: Literal "null" tokens.
# - NUMBER: Numeric tokens.
# - OBJECT: Curly braces used for object literals.
# - STRING: Strings that are NOT object keys.
# - TRUE: Literal "true" tokens.
set -e -u

# Defaults
ARRAY="1;37"
FALSE="0;37"
FIELD="1;34"
NULL="1;30"
NUMBER="0;37"
OBJECT="1;37"
STRING="0;32"
TRUE="0;37"

if [ "${1:-}" ]; then
    path="$1"

    while read -r name sequence extra; do
        lineno="$((${lineno:-0} + 1))"

        # Handle comments
        name="${name%%#*}"
        sequence="${sequence%%#*}"
        extra="${extra%%#*}"

        case "$name" in
          ARRAY|FALSE|FIELD|NULL|NUMBER|OBJECT|STRING|TRUE)
            case "$extra" in
              ?*)
                echo "${0##*/}: $path: line $lineno is malformed" >&2
                exit 1
              ;;
            esac

            case "$sequence" in
              "")
                echo "${0##*/}: $path: line $lineno is malformed" >&2
                exit 1
              ;;
            esac

            eval "$name=\"\$sequence\""
          ;;

          "") ;; # Blank lines and comments.

          *)
            echo "${0##*/}: $name: unrecognized token type" >&2
            exit 1
          ;;
        esac
    done < "$path"
fi

echo "JQ_COLORS='$NULL:$FALSE:$TRUE:$NUMBER:$STRING:$ARRAY:$OBJECT:$FIELD';"
echo "export JQ_COLORS"
